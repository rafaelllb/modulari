<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulari - Detalhes do Im√≥vel</title>
    <link rel="stylesheet" href="base-styles.css">
    <style>
        .property-header {
            position: relative;
            height: 60vh;
            min-height: 400px;
            background-size: cover;
            background-position: center;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
        }

        .property-header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: var(--spacing-xl);
            color: var(--surface);
        }

        .property-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: var(--spacing-xs);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .property-price {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .property-location {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 1.1rem;
            margin-bottom: var(--spacing-sm);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .property-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .property-tag {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
        }

        .property-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .action-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            transition: all 0.2s;
        }

        .match-badge {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--primary);
            color: var(--surface);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .match-badge.high-match {
            background: linear-gradient(135deg, var(--primary), #4a6fa5);
            animation: pulse 2s infinite;
        }

        .content-section {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .detail-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .detail-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .detail-label {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-sm);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--surface-alt);
            border-radius: var(--radius-sm);
        }

        .feature-icon {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .match-details {
            background: var(--surface-alt);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .match-reason {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--surface);
            border-radius: var(--radius-sm);
        }

        .match-icon {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .match-description strong {
            color: var(--primary);
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .gallery-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        .notes-section {
            margin-top: var(--spacing-lg);
        }

        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--spacing-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            font-family: inherit;
            resize: vertical;
        }

        .similar-properties {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .property-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .property-card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .property-card-content {
            padding: var(--spacing-sm);
        }

        .property-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .property-card-price {
            font-size: 1rem;
            font-weight: 500;
            color: var(--success);
            margin-bottom: var(--spacing-xs);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .property-header {
                height: 40vh;
                min-height: 300px;
            }

            .property-title {
                font-size: 1.75rem;
            }

            .property-price {
                font-size: 1.25rem;
            }

            .property-actions {
                flex-direction: column;
            }

            .action-button {
                width: 100%;
            }

            .details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <header class="header" id="header-content">
            <div class="header-content">
                <h1 class="logo">Modulari</h1>
                <button class="button button-secondary" onclick="goBack()">
                    Voltar
                </button>
            </div>
        </header>

        <div id="property-container">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>

    <!-- Modais -->
    <div class="modal" id="share-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Compartilhar Im√≥vel</h3>
                <button class="modal-close" onclick="closeModal('share-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Escolha como compartilhar este im√≥vel:</p>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); margin: var(--spacing-md) 0;">
                    <button class="button button-primary" onclick="shareViaWhatsApp()">
                        WhatsApp
                    </button>
                    <button class="button button-primary" onclick="shareViaEmail()">
                        Email
                    </button>
                    <button class="button button-primary" onclick="copyLink()">
                        Copiar Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script type="module">
        import dataService from './data-service.js';
        import permissionService from './permission-service.js';

        import { renderHeader } from './header-component.js';

        document.addEventListener('DOMContentLoaded', function() {
            renderHeader('header-container');
        });

        // Verificar autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            
            // Verificar se h√° uma propriedade selecionada
            const currentProperty = dataService.getCurrentProperty();
            
            // Se n√£o houver, tentar obter de query params
            if (!currentProperty) {
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('id');
                
                if (propertyId) {
                    const property = dataService.getPropertyById(propertyId);
                    if (property) {
                        dataService.setCurrentProperty(property);
                        loadPropertyDetails(property);
                    } else {
                        showError('Im√≥vel n√£o encontrado');
                    }
                } else {
                    showError('Nenhum im√≥vel selecionado');
                }
            } else {
                loadPropertyDetails(currentProperty);
            }
        });

        // Fun√ß√£o para mostrar loading
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('show');
        }

        // Fun√ß√£o para esconder loading
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }

        // Fun√ß√£o para mostrar erro
        function showError(message) {
            hideLoading();
            document.getElementById('property-container').innerHTML = `
                <div class="content-section" style="text-align: center; padding: var(--spacing-xl);">
                    <h2 style="margin-bottom: var(--spacing-md); color: var(--text);">${message}</h2>
                    <p style="margin-bottom: var(--spacing-lg); color: var(--text-light);">
                        N√£o foi poss√≠vel carregar os detalhes do im√≥vel.
                    </p>
                    <button class="button button-primary" onclick="window.location.href='property-cards.html'">
                        Explorar im√≥veis
                    </button>
                </div>
            `;
        }

        // Fun√ß√£o para carregar detalhes do im√≥vel
        function loadPropertyDetails(property) {
            try {
                if (!property) {
                    showError('Im√≥vel n√£o encontrado');
                    return;
                }
                
                // Calcular match score
                const activeProfile = dataService.getActiveProfile();
                let matchScore = 0;
                let matchReasons = [];
                
                if (activeProfile) {
                    matchScore = dataService.calculateMatchScore(property, activeProfile.preferences);
                    matchReasons = generateMatchReasons(property, activeProfile.preferences);
                }
                
                // Carregar notas salvas
                let savedNotes = '';
                if (activeProfile) {
                    const matches = dataService.getProfileMatches(activeProfile.id);
                    const savedMatch = matches.find(m => m.id === property.id);
                    if (savedMatch) {
                        savedNotes = savedMatch.notes || '';
                    }
                }
                
                // Extrair caracter√≠sticas principais para o topo
                const size = property.features.find(f => f.includes('m¬≤')) || '√Årea n√£o informada';
                const bedrooms = property.features.find(f => f.includes('quarto')) || 'Quartos n√£o informados';
                const location = property.details.location || 'Localiza√ß√£o n√£o informada';
                
                // Gerar detalhes HTML
                document.getElementById('property-container').innerHTML = `
                    <div class="property-header" style="background-image: url('${property.image}');">
                        <div class="property-header-overlay">
                            <h1 class="property-title">${property.title}</h1>
                            <p class="property-price">${property.price}</p>
                            <div class="property-location">
                                <span>üìç</span> ${property.details.address || location}
                            </div>
                            <div class="property-tags">
                                ${property.features.slice(0, 4).map(feature => `
                                    <span class="property-tag">${feature}</span>
                                `).join('')}
                            </div>
                            <div class="property-actions">
                                <button class="action-button" style="background: var(--surface); color: var(--text);" 
                                        onclick="scheduleVisit()">
                                    <span>üìÖ</span> Agendar Visita
                                </button>
                                <button class="action-button" style="background: var(--success); color: var(--surface);" 
                                        onclick="saveProperty(${property.id})">
                                    <span>üíñ</span> Salvar
                                </button>
                                <button class="action-button" style="background: var(--primary); color: var(--surface);" 
                                        onclick="openShareModal()">
                                    <span>üì§</span> Compartilhar
                                </button>
                            </div>
                            ${matchScore > 0 ? `
                                <div class="match-badge ${matchScore > 85 ? 'high-match' : ''}">
                                    <span>üéØ</span> ${matchScore}% match
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-lg);">
                        <div class="content-section">
                            <h2 class="section-title">
                                <span>üìã</span> Detalhes do Im√≥vel
                            </h2>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-icon">üìè</span>
                                    <span class="detail-value">${size}</span>
                                    <span class="detail-label">√Årea Total</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üõèÔ∏è</span>
                                    <span class="detail-value">${bedrooms}</span>
                                    <span class="detail-label">Dormit√≥rios</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üèôÔ∏è</span>
                                    <span class="detail-value">${location}</span>
                                    <span class="detail-label">Localiza√ß√£o</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üîä</span>
                                    <span class="detail-value">${getNoiseLevelText(property.details.noiseLevel)}</span>
                                    <span class="detail-label">N√≠vel de Ru√≠do</span>
                                </div>
                            </div>
                            
                            <h3 class="section-title" style="font-size: 1.2rem;">
                                <span>‚ú®</span> Caracter√≠sticas
                            </h3>
                            <div class="features-grid">
                                ${property.features.map(feature => `
                                    <div class="feature-item">
                                        <span class="feature-icon">${getFeatureIcon(feature)}</span>
                                        <span>${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${matchReasons.length > 0 ? `
                                <div class="match-details">
                                    <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: var(--spacing-sm);">
                                        <span>üéØ</span> Por que este im√≥vel combina com voc√™
                                    </h3>
                                    ${matchReasons.map(reason => `
                                        <div class="match-reason">
                                            <span class="match-icon">${reason.icon}</span>
                                            <div class="match-description">${reason.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="content-section">
                            <h2 class="section-title">
                                <span>üìù</span> Descri√ß√£o
                            </h2>
                            <p>${property.details.description || 'Descri√ß√£o n√£o dispon√≠vel.'}</p>
                            
                            <div class="image-gallery">
                                <!-- Simula√ß√£o de mais imagens -->
                                <img src="${property.image}" alt="${property.title}" class="gallery-image">
                                <img src="${property.image}" alt="${property.title}" class="gallery-image">
                                <img src="${property.image}" alt="${property.title}" class="gallery-image">
                                <img src="${property.image}" alt="${property.title}" class="gallery-image">
                            </div>
                        </div>
                        
                        ${activeProfile ? `
                            <div class="content-section notes-section">
                                <h2 class="section-title">
                                    <span>üìã</span> Suas Anota√ß√µes
                                </h2>
                                <textarea 
                                    class="notes-textarea" 
                                    id="property-notes" 
                                    placeholder="Adicione suas observa√ß√µes sobre este im√≥vel..."
                                    onchange="saveNotes(event.target.value, ${property.id})"
                                >${savedNotes}</textarea>
                            </div>
                        ` : ''}
                        
                        <div class="content-section">
                            <h2 class="section-title">
                                <span>üè†</span> Im√≥veis Similares
                            </h2>
                            <div class="similar-properties" id="similar-properties">
                                <!-- Ser√° preenchido dinamicamente -->
                            </div>
                        </div>
                    </div>
                `;
                
                // Carregar im√≥veis similares
                loadSimilarProperties(property);
                
                hideLoading();
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                showError('Erro ao carregar detalhes do im√≥vel');
            }
        }

        // Fun√ß√£o para carregar im√≥veis similares
        function loadSimilarProperties(currentProperty) {
            try {
                // Obter im√≥veis do mesmo tipo/localiza√ß√£o
                const lifestyle = dataService.getSelectedLifestyle() || 'beach';
                let similarProperties = dataService.getPropertiesByLifestyle(lifestyle);
                
                // Filtrar o im√≥vel atual
                similarProperties = similarProperties.filter(p => p.id !== currentProperty.id);
                
                // Limitar a 3 im√≥veis
                similarProperties = similarProperties.slice(0, 3);
                
                if (similarProperties.length === 0) {
                    document.getElementById('similar-properties').innerHTML = `
                        <p>Nenhum im√≥vel similar encontrado.</p>
                    `;
                    return;
                }
                
                // Renderizar im√≥veis similares
                document.getElementById('similar-properties').innerHTML = similarProperties.map(property => `
                    <div class="property-card" onclick="viewProperty(${property.id})">
                        <img src="${property.image}" alt="${property.title}" class="property-card-image">
                        <div class="property-card-content">
                            <h3 class="property-card-title">${property.title}</h3>
                            <p class="property-card-price">${property.price}</p>
                            <div class="property-tags" style="margin: 0;">
                                ${property.features.slice(0, 2).map(feature => `
                                    <span class="property-tag" style="background: var(--surface-alt);">${feature}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar im√≥veis similares:', error);
                document.getElementById('similar-properties').innerHTML = `
                    <p>Erro ao carregar im√≥veis similares.</p>
                `;
            }
        }

        // Fun√ß√£o para gerar raz√µes de match
        function generateMatchReasons(property, preferences) {
            if (!preferences) return [];
            
            const reasons = [];
            
            // Verificar prop√≥sito
            if (preferences.purpose === 'invest' && property.details.investmentPotential) {
                reasons.push({
                    icon: 'üí∞',
                    text: 'Este im√≥vel tem <strong>alto potencial de valoriza√ß√£o</strong>, ideal para seu objetivo de investimento.'
                });
            } else if (preferences.purpose === 'live' && property.features.includes('√Årea tranquila')) {
                reasons.push({
                    icon: 'üè°',
                    text: 'Este im√≥vel est√° em uma <strong>√°rea tranquila</strong>, perfeito para seu objetivo de moradia.'
                });
            } else if (preferences.purpose === 'both' && 
                      property.details.investmentPotential && 
                      property.features.includes('√Årea tranquila')) {
                reasons.push({
                    icon: '‚öñÔ∏è',
                    text: 'Este im√≥vel combina <strong>potencial de investimento</strong> e <strong>qualidade para moradia</strong>, atendendo seu objetivo duplo.'
                });
            }

            // Verificar estilo de vida
            if (preferences.lifestyle === 'quiet' && 
                (property.details.noiseLevel === 'low' || property.details.noiseLevel === 'very_low')) {
                reasons.push({
                    icon: 'üåø',
                    text: 'O <strong>ambiente tranquilo</strong> deste im√≥vel combina com sua prefer√™ncia por locais calmos.'
                });
            } else if (preferences.lifestyle === 'active' && property.details.nearActivities) {
                reasons.push({
                    icon: 'üèôÔ∏è',
                    text: 'A <strong>proximidade a atividades e servi√ßos</strong> atende sua prefer√™ncia por um estilo de vida ativo.'
                });
            } else if (preferences.lifestyle === 'balanced') {
                if (property.features.includes('Pr√≥ximo ao centro') && 
                    property.features.includes('√Årea tranquila')) {
                    reasons.push({
                        icon: '‚òØÔ∏è',
                        text: 'Este im√≥vel oferece um <strong>equil√≠brio entre tranquilidade e proximidade a servi√ßos</strong>, ideal para seu estilo de vida balanceado.'
                    });
                }
            }

            // Verificar prioridades
            if (preferences.priorities) {
                const size = parseInt(property.features.find(f => f.includes('m¬≤'))?.replace(/\D/g, '') || '0');
                
                if (preferences.priorities.includes('space') && size > 150) {
                    reasons.push({
                        icon: 'üìè',
                        text: `Com <strong>${size}m¬≤</strong>, este im√≥vel atende sua prioridade por espa√ßos amplos.`
                    });
                }
                
                if (preferences.priorities.includes('location') && 
                    (property.details.location.includes('Primeira quadra') || 
                     property.details.location.includes('Centro'))) {
                    reasons.push({
                        icon: 'üìç',
                        text: `A <strong>localiza√ß√£o privilegiada</strong> em ${property.details.location} combina com suas prioridades.`
                    });
                }
                
                if (preferences.priorities.includes('privacy') && 
                    property.features.includes('Condom√≠nio fechado')) {
                    reasons.push({
                        icon: 'üîí',
                        text: 'Este im√≥vel est√° em um <strong>condom√≠nio fechado</strong>, oferecendo a privacidade que voc√™ valoriza.'
                    });
                }
                
                if (preferences.priorities.includes('amenities') && 
                    (property.features.includes('Academia') || 
                     property.features.includes('Piscina'))) {
                    const amenities = [];
                    if (property.features.includes('Academia')) amenities.push('academia');
                    if (property.features.includes('Piscina')) amenities.push('piscina');
                    
                    reasons.push({
                        icon: '‚ú®',
                        text: `As <strong>comodidades</strong> como ${amenities.join(' e ')} atendem √†s suas prioridades.`
                    });
                }
            }

            // Limitar a 3 raz√µes para n√£o sobrecarregar
            return reasons.slice(0, 3);
        }

        // Fun√ß√£o para obter √≠cone baseado na caracter√≠stica
        function getFeatureIcon(feature) {
            if (feature.toLowerCase().includes('quarto')) return 'üõèÔ∏è';
            if (feature.toLowerCase().includes('m¬≤')) return 'üìè';
            if (feature.toLowerCase().includes('piscina')) return 'üèä';
            if (feature.toLowerCase().includes('academia')) return 'üèãÔ∏è';
            if (feature.toLowerCase().includes('vista')) return 'üåÖ';
            if (feature.toLowerCase().includes('varanda')) return 'üèûÔ∏è';
            if (feature.toLowerCase().includes('tranquila')) return 'üåø';
            if (feature.toLowerCase().includes('√°rea verde')) return 'üå≥';
            if (feature.toLowerCase().includes('condom√≠nio')) return 'üè¢';
            if (feature.toLowerCase().includes('mar')) return 'üåä';
            if (feature.toLowerCase().includes('centro')) return 'üèôÔ∏è';
            if (feature.toLowerCase().includes('pr√≥ximo')) return 'üö∂';
            if (feature.toLowerCase().includes('potencial')) return 'üí∞';
            
            return '‚ú®'; // √≠cone padr√£o
        }

        // Fun√ß√£o para obter texto do n√≠vel de ru√≠do
        function getNoiseLevelText(level) {
            switch (level) {
                case 'very_low': return 'Muito Baixo';
                case 'low': return 'Baixo';
                case 'medium': return 'M√©dio';
                case 'high': return 'Alto';
                default: return 'N√£o informado';
            }
        }

        // Exportar fun√ß√µes para o escopo global
        window.viewProperty = function(propertyId) {
            const property = dataService.getPropertyById(propertyId);
            if (property) {
                dataService.setCurrentProperty(property);
                window.location.reload();
            }
        };

        window.saveProperty = function(propertyId) {
            const activeProfile = dataService.getActiveProfile();
            
            if (!activeProfile) {
                showToast('√â necess√°rio ter um perfil ativo para salvar im√≥veis', 'warning');
                return;
            }
            
            const property = dataService.getPropertyById(propertyId);
            if (!property) {
                showToast('Im√≥vel n√£o encontrado', 'error');
                return;
            }
            
            // Verificar se j√° est√° salvo
            const matches = dataService.getProfileMatches(activeProfile.id);
            if (matches.some(m => m.id === propertyId)) {
                showToast('Este im√≥vel j√° est√° salvo nos seus matches', 'warning');
                return;
            }
            
            // Adicionar match
            property.match = dataService.calculateMatchScore(property, activeProfile.preferences);
            const result = dataService.addMatch(activeProfile.id, property);
            
            if (result) {
                showToast('Im√≥vel salvo com sucesso!', 'success');
            } else {
                showToast('Erro ao salvar im√≥vel', 'error');
            }
        };

        window.saveNotes = function(notes, propertyId) {
            const activeProfile = dataService.getActiveProfile();
            
            if (!activeProfile) {
                showToast('√â necess√°rio ter um perfil ativo para salvar anota√ß√µes', 'warning');
                return;
            }
            
            // Verificar se j√° est√° salvo
            const matches = dataService.getProfileMatches(activeProfile.id);
            const existingMatch = matches.find(m => m.id === propertyId);
            
            if (existingMatch) {
                // Atualizar notas do match existente
                dataService.updateMatch(activeProfile.id, propertyId, { notes });
                showToast('Anota√ß√µes salvas com sucesso!', 'success');
            } else {
                // Salvar o im√≥vel primeiro
                saveProperty(propertyId);
                // Tentar novamente depois que o im√≥vel for salvo
                setTimeout(() => {
                    const property = dataService.getPropertyById(propertyId);
                    if (property) {
                        property.match = dataService.calculateMatchScore(property, activeProfile.preferences);
                        const match = dataService.addMatch(activeProfile.id, property);
                        if (match) {
                            dataService.updateMatch(activeProfile.id, propertyId, { notes });
                        }
                    }
                }, 100);
            }
        };

        window.scheduleVisit = function() {
            showToast('Agendamento de visitas em breve!', 'info');
        };

        window.openShareModal = function() {
            document.getElementById('share-modal').style.display = 'flex';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.shareViaWhatsApp = function() {
            const property = dataService.getCurrentProperty();
            if (!property) return;
            
            const text = `Olha que im√≥vel interessante que encontrei no Modulari!\n\n${property.title}\n${property.price}\n\n${property.details.description?.substring(0, 100)}...\n\nVeja mais detalhes: ${window.location.href}`;
            
            const encodedText = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            
            closeModal('share-modal');
        };

        window.shareViaEmail = function() {
            const property = dataService.getCurrentProperty();
            if (!property) return;
            
            const subject = `Im√≥vel interessante: ${property.title}`;
            const body = `Olha que im√≥vel interessante que encontrei no Modulari!\n\n${property.title}\n${property.price}\n\n${property.details.description?.substring(0, 100)}...\n\nVeja mais detalhes: ${window.location.href}`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            closeModal('share-modal');
        };

        window.copyLink = function() {
            navigator.clipboard.writeText(window.location.href)
                .then(() => {
                    showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
                    closeModal('share-modal');
                })
                .catch(() => {
                    // Fallback para navegadores que n√£o suportam clipboard API
                    const input = document.createElement('input');
                    input.value = window.location.href;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    
                    showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
                    closeModal('share-modal');
                });
        };

        window.goBack = function() {
            // Se houver hist√≥rico, volta
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Caso contr√°rio, vai para a p√°gina de cards
                window.location.href = 'property-cards.html';
            }
        };

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-message">${message}</span>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>